
<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Validation & Claims — PoC</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Modern styling with responsive two-column forms -->
    <style>
        :root {
          --bg: #0b0c10;
          --panel: #14161a;
          --text: #e5e7eb;
          --muted: #a7b0bf;
          --primary: #4f46e5;
          --primary-hover: #4338ca;
          --success: #059669;
          --danger: #dc2626;
          color-scheme: light dark;
        }
        @media (prefers-color-scheme: light) {
          :root {
            --bg: #f6f7fb;
            --panel: #ffffff;
            --text: #111827;
            --muted: #6b7280;
            --primary: #3949ab;
            --primary-hover: #303f9f;
            --success: #0f766e;
            --danger: #b91c1c;
          }
        }
        * { box-sizing: border-box; }
        body {
          margin: 0;
          font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
          background: var(--bg);
          color: var(--text);
          line-height: 1.6;
        }

        header {
          padding: 2rem 1.5rem 0;
          max-width: 1200px;
          margin-inline: auto;
        }
        h1 {
          margin: 0 0 .5rem 0;
          font-weight: 700;
          letter-spacing: .2px;
        }
        p.subtitle {
          margin: 0;
          color: var(--muted);
        }
        .mono {
          font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        }

        /* Page layout using flexbox */
        .grid {
          display: flex;
          flex-wrap: wrap;
          gap: 1.25rem;
          padding: 1.5rem;
          max-width: 1200px;
          margin-inline: auto;
        }

        /* Cards: default full width on mobile */
        section.card {
          flex: 1 1 100%;
          background: var(--panel);
          border: 1px solid rgba(255,255,255,.08);
          border-radius: 14px;
          padding: 1.25rem;
          box-shadow: 0 6px 24px rgba(0,0,0,.12);
        }

        /* On desktop: two cards side by side (approx 50%) */
        @media (min-width: 900px) {
          section.card {
            flex: 1 1 48%; /* two cards per row */
          }
          section.card.wide {
            flex: 1 1 100%; /* full width for wide sections */
          }
        }

        section.card h2 {
          margin: 0 0 .75rem 0;
          font-weight: 600;
          font-size: 1.25rem;
        }

        /* Two-column form layout (responsive) */
        form.form-grid {
          display: grid;
          grid-template-columns: 1fr;              /* 1 column on mobile */
          gap: .8rem 1rem;
        }
        @media (min-width: 900px) {
          form.form-grid {
            grid-template-columns: 1fr 1fr;        /* 2 columns on desktop */
          }
        }
        .field {
          display: grid;
          grid-template-columns: 1fr;
          gap: .3rem;
        }
        .form-output {
          grid-column: 1 / -1;                     /* spans both columns */
        }

        label { font-size: .9rem; color: var(--muted); }
        input, select {
          width: 100%;
          padding: .55rem .7rem;
          border-radius: 10px;
          border: 1px solid rgba(255,255,255,.12);
          background: transparent;
          color: var(--text);
          outline: none;
        }
        input::placeholder { color: var(--muted); }

        .actions {
          grid-column: 1 / -1;
          display: flex;
          gap: .6rem;
          flex-wrap: wrap;
          margin-top: .2rem;
        }
        button, .btn {
          display: inline-flex;
          align-items: center;
          gap: .5rem;
          border: none;
          border-radius: 12px;
          padding: .6rem 1rem;
          font-weight: 600;
          cursor: pointer;
          text-decoration: none;
          background: var(--primary);
          color: #fff;
          transition: background .2s ease, transform .05s ease;
        }
        button:hover, .btn:hover { background: var(--primary-hover); }
        button:active, .btn:active { transform: translateY(1px); }
        .btn-outline { background: transparent; color: var(--primary); border: 1px solid var(--primary); }
        .btn-success { background: var(--success); }
        .btn-danger  { background: var(--danger); }

        pre {
          background: #f9fafb;
          color: #111827;
          border: 1px solid #e5e7eb;
          border-radius: 12px;
          padding: .8rem;
          overflow: auto;
          max-height: 28rem;
          font-size: .92rem;
        }

        footer {
          max-width: 1200px;
          margin: 1rem auto 2rem;
          padding: 0 1.5rem;
          color: var(--muted);
          font-size: .9rem;
        }
        .helper-note {
          color:#6b7280;
          margin-top:.6rem;
          font-size:.9rem;
        }
        .code-pill {
          font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
          background:#0001;
          padding:2px 6px;
          border-radius:6px;
        }
    </style>
</head>

<body>
<header>
    <h1>Validation &amp; Claims — PoC</h1>
    <p class="subtitle">Win check, claim update, H2 data viewer &amp; API documentation</p>
</header>

<main class="grid">

    <!-- Check winner -->
    <section class="card">
        <h2>Check winner</h2>
        <form id="winForm" class="form-grid">
            <div class="field"><label>customer_id</label><input name="customer_id" value="11" placeholder="e.g., 11" inputmode="numeric" pattern="\d*"></div>
            <div class="field"><label>game_id</label><input name="game_id" value="101" placeholder="e.g., 101" inputmode="numeric" pattern="\d*"></div>
            <div class="field"><label>batch_id</label><input name="batch_id" value="01" placeholder="e.g., 01" inputmode="numeric" pattern="\d*"></div>
            <div class="field"><label>ticket_id</label><input name="ticket_id" value="007" placeholder="e.g., 007" inputmode="numeric" pattern="\d*"></div>
            <div class="field"><label>pack_id</label><input name="pack_id" value="0000123" placeholder="optional (max 7 digits)" inputmode="numeric" pattern="\d*"></div>

            <div class="actions">
                <button type="submit" class="btn-success">Check</button>
                <button type="reset" class="btn-outline">Clear</button>
            </div>

            <pre id="winOut" class="mono form-output">{ response appears here }</pre>
        </form>
    </section>

    <!-- Update claim status -->
    <section class="card">
        <h2>Update claim status</h2>
        <form id="claimForm" class="form-grid">
            <div class="field"><label>customer_id</label><input name="customer_id" value="11" inputmode="numeric" pattern="\d*"></div>
            <div class="field"><label>game_id</label><input name="game_id" value="101" inputmode="numeric" pattern="\d*"></div>
            <div class="field"><label>batch_id</label><input name="batch_id" value="01" inputmode="numeric" pattern="\d*"></div>
            <div class="field"><label>ticket_id</label><input name="ticket_id" value="007" inputmode="numeric" pattern="\d*"></div>
            <div class="field"><label>pack_id</label><input name="pack_id" value="0000123" inputmode="numeric" pattern="\d*"></div>
            <div class="field"><label>desired_claim_value</label>
                <select name="desired_claim_value"><option>1</option><option>2</option></select>
            </div>
            <div class="field"><label>f1</label><input name="f1" value="channel"></div>
            <div class="field"><label>f2</label><input name="f2" value="device"></div>
            <div class="field"><label>f3</label><input name="f3" value="person"></div>
            <div class="field"><label>f4</label><input name="f4" value="external_ref"></div>

            <div class="actions">
                <button type="submit" class="btn-success">Submit</button>
                <button type="reset" class="btn-outline">Clear</button>
            </div>

            <pre id="claimOut" class="mono form-output">{ response appears here }</pre>
        </form>
    </section>

    <!-- H2 data viewer -->
    <section class="card wide">
        <h2>H2 data browser</h2>
        <div class="actions">
            <button id="loadGames">Show games</button>
            <button id="loadWinners">Show winners (first 50)</button>
            <button id="loadClaimlog">Show claimlog (last 50)</button>
        </div>
        <pre id="dataOut" class="mono">{ data appears here }</pre>
    </section>

</main>

<footer>
    PoC: functionality &gt; performance • Win + Claim • DB-agnostic (JPA/Hibernate) • pack activation out of scope
</footer>

<script>
    /** ---- Utilities ---- **/
    async function postJson(url, data) {
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      const txt = await res.text();
      let parsed; try { parsed = JSON.parse(txt); } catch { parsed = txt; }
      return { ok: res.ok, status: res.status, body: parsed };
    }
    async function getJson(url) {
      const res = await fetch(url);
      const txt = await res.text();
      let parsed; try { parsed = JSON.parse(txt); } catch { parsed = txt; }
      return { ok: res.ok, status: res.status, body: parsed };
    }
    const formToObj = (form) => Object.fromEntries(new FormData(form).entries());

    /** ---- Zero-fill helpers (frontend mirror of backend zfillDigits) ---- **/
    function padLeftDigits(value, length) {
      const v = (value ?? '').toString().replace(/\D/g, ''); // keep only digits
      // pad and hard-truncate to the target length (prevents overflow)
      return v.padStart(length, '0').slice(-length);
    }

    const padConfig = {
      customer_id: 2,
      game_id: 3,
      batch_id: 2,
      ticket_id: 3,
      pack_id: 7
    };

    /** Add listeners to ALL inputs across both forms */
    function attachPadListeners() {
      Object.entries(padConfig).forEach(([name, len]) => {
        document.querySelectorAll(`input[name="${name}"]`).forEach((input) => {
          const handler = () => {
            if (input.value.trim() !== '') {
              input.value = padLeftDigits(input.value, len);
            }
          };
          input.addEventListener('blur', handler);
          input.addEventListener('change', handler);
          // If you want live formatting while typing, uncomment:
          // input.addEventListener('input', handler);
        });
      });
    }

    /** Normalize data object prior to sending (last line of defense) */
    function normalizeFormDataObject(data) {
      for (const [name, len] of Object.entries(padConfig)) {
        if (name in data && data[name] != null && String(data[name]).trim() !== '') {
          data[name] = padLeftDigits(String(data[name]), len);
        }
      }
      return data;
    }

    /** Normalize current DOM input values (so user sees 001/etc.) */
    function normalizeFormInputsInDom(form) {
      Object.entries(padConfig).forEach(([name, len]) => {
        form.querySelectorAll(`input[name="${name}"]`).forEach((input) => {
          if (input.value.trim() !== '') {
            input.value = padLeftDigits(input.value, len);
          }
        });
      });
    }

    /** ---- Init after DOM ready ---- **/
    document.addEventListener('DOMContentLoaded', () => {
      attachPadListeners();

      // --- WIN FORM ---
      document.getElementById('winForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        normalizeFormInputsInDom(e.target); // update visible inputs
        const data = normalizeFormDataObject(formToObj(e.target)); // normalize payload

        const out = document.getElementById('winOut');
        const resp = await postJson('/api/win/check', data);
        out.textContent = typeof resp.body === 'string'
          ? resp.body
          : JSON.stringify(resp.body, null, 2);
      });

      // --- CLAIM FORM ---
      document.getElementById('claimForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        normalizeFormInputsInDom(e.target);
        const data = normalizeFormDataObject(formToObj(e.target));

        if ('desired_claim_value' in data) {
          data.desired_claim_value = parseInt(data.desired_claim_value, 10);
        }
        const out = document.getElementById('claimOut');
        const resp = await postJson('/api/claim', data);
        out.textContent = typeof resp.body === 'string'
          ? resp.body
          : JSON.stringify(resp.body, null, 2);
      });

      // Optional: clear outputs on reset for nicer UX
      document.querySelectorAll('form').forEach(form => {
        form.addEventListener('reset', () => {
          setTimeout(() => {
            const pre = form.querySelector('pre');
            if (pre) pre.textContent = '{ response appears here }';
          });
        });
      });

      // --- H2 browser buttons ---
      document.getElementById('loadGames').addEventListener('click', async () => {
        const out = document.getElementById('dataOut');
        const resp = await getJson('/ui/games');
        out.textContent = typeof resp.body === 'string'
          ? resp.body
          : JSON.stringify(resp.body, null, 2);
      });
      document.getElementById('loadWinners').addEventListener('click', async () => {
        const out = document.getElementById('dataOut');
        const resp = await getJson('/ui/winners?limit=50');
        out.textContent = typeof resp.body === 'string'
          ? resp.body
          : JSON.stringify(resp.body, null, 2);
      });
      document.getElementById('loadClaimlog').addEventListener('click', async () => {
        const out = document.getElementById('dataOut');
        const resp = await getJson('/ui/claimlog?limit=50');
        out.textContent = typeof resp.body === 'string'
          ? resp.body
          : JSON.stringify(resp.body, null, 2);
      });
    });
</script>
</body>
</html>
